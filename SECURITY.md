# SECURITY

最重要: 本アプリは「任意のPythonコードを実行」します。ローカル開発者向けを前提としており、既定のままインターネット公開することは強く非推奨です。なお、Community Edition ではライセンス上も公衆インターネットへの公開を禁止しています（詳細は `LICENSE.md` を参照）。

## 運用モード

- ローカル（推奨/MVP）
  - 端末上でのみ使用。外部公開なし。
  - 認証トークンは不要（任意）ですが、同一端末内の他プロセスからのアクセスもあり得るため、必要に応じて `PYFLOWS_API_TOKEN` を設定してください。

- ホスト（将来/有償化想定）
  - リバースプロキシ（TLS）やIDプロバイダの前段保護が前提。
  - カーネル実行は隔離（例: Jupyter Enterprise Gateway）を推奨。

## 脅威と対策（要点）

- RCE（任意コード実行）/ データ持ち出し / 内部横展開 / DoS
  - 前段での認証・認可（SSO/OIDC、必須トークン、ロール）
  - ネットワーク制御（VPN/IP許可リスト、L7 WAF、レート制限）
  - カーネル隔離（ユーザー/テナント単位の分離、リソースクォータ）
  - コンテナの最小権限（非root、read-only FS、cap drop、seccomp/AppArmor/SELinux）
  - 出口制御（egress制限）、ファイルI/Oパスのサンドボックス
  - 入力サイズ/形式の制限（アップロード/実行時間/メモリ）
  - CORSの明示制限（自ドメインのみ）、Cookie未使用、トークンはヘッダ

## ホスト運用向けハードニング・チェックリスト

1) ネットワーク・暗号化
   - [ ] すべてHTTPS（TLS）
   - [ ] 逆プロキシでHTTP→HTTPS強制、HSTS
   - [ ] IP許可リスト or VPN の内側のみ
2) 認証・認可
   - [ ] 前段でOIDC/SSO（Azure AD等）
   - [ ] `PYFLOWS_API_TOKEN` を必須化（プロキシでヘッダ付与でも可）
   - [ ] CORSは自ドメインのみ
3) 実行環境の隔離
   - [ ] Jupyter Enterprise Gateway でユーザー毎に独立カーネル
   - [ ] コンテナ: 非root、cap drop、read-only FS、限定ボリューム
   - [ ] CPU/メモリ/実行時間の制限（例: `PYFLOWS_EXEC_TIMEOUT`）
4) 観測性・監査
   - [ ] 監査ログ（実行開始/終了/エラー/ダウンロード）
   - [ ] メトリクス/アラート（エラー率、実行時間、メモリ）
5) 秘密情報の保護
   - [ ] 環境変数/シークレットの最小化、KMS/KeyVault管理
   - [ ] エラーメッセージ/ログの機密情報マスク

## Jupyter Enterprise Gateway（参考）

リモート/隔離カーネルを使う場合は以下を設定します。

```
JUPYTER_GATEWAY_URL=https://<gateway-host>/gateway
JUPYTER_GATEWAY_AUTH_TOKEN=<token>
```

本アプリ側は、設定が存在すればGateway経由、なければローカルカーネルにフォールバックします。

## インシデント対応の方針

- 影響範囲の特定（実行ログ/監査ログ/アクセスログ）
- トークン・資格情報のローテーション
- 侵害端末/コンテナの隔離と再作成（不変インフラ）
- 再発防止（追加制御、最小権限化、レビュー）

## 連絡

脆弱性やセキュリティに関する報告は、Issue ではなくプライベートな連絡手段をご利用ください（運用ポリシー確定までは、公開レポジトリでの機微情報掲載を避けてください）。
